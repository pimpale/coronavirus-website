let instruction2Map=null,instruction2Points=null,instruction2Markers=[],exclusionZones=[];function loadInstruction2Map(){instruction2Map=L.map("instruction2-map"),instruction2Map.setView([0,0],2),L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,minZoom:2,id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoicGltcGFsZSIsImEiOiJjazhkbzk4NTIwdHkzM21vMWFiNHIzZ3BiIn0.nLv4P71SFh4TIANuwJ8I9A"}).addTo(instruction2Map);const t=L.featureGroup().addTo(instruction2Map);function i(){exclusionZones=[],t.eachLayer((t=>{exclusionZones.push(t.getBounds())}))}instruction2Map.addControl(new L.Control.Draw({position:"topright",edit:{featureGroup:t,edit:!1,poly:{allowIntersection:!1}},draw:{featureGroup:t,polyline:!1,polygon:!1,circle:!1,marker:!1,rectangle:!0,circlemarker:!1}})),instruction2Map.on(L.Draw.Event.CREATED,(async function(n){rendering||(t.addLayer(n.layer),i(),await renderInstruction2Map())})),instruction2Map.on(L.Draw.Event.DELETED,(async function(n){rendering||(t.removeLayer(n.layer),i(),await renderInstruction2Map())}))}function addInstruction2Marker(t,i){let n=new L.Marker(t);instruction2Map.addLayer(n),null!=i&&n.bindPopup(i),instruction2Markers.push(n)}let rendering=!1;function getValidPoints(){return instruction2Points.filter((t=>{for(const i of exclusionZones)if(i.contains([t.latitude,t.longitude]))return!1;return!0}))}async function renderInstruction2Map(){rendering=!0;for(let t=0;t<instruction2Markers.length;t++)instruction2Map.removeLayer(instruction2Markers[t]);instruction2Markers=[],$("#instruction2-map-progress-div").show();const t=getValidPoints(),i=t.length;$("#instruction2-counter").html(`${(i/1e4).toFixed(2)}/10.00 Megabytes Used`),i/1e4<10?$("#instruction2-confirm").prop("disabled",!1):$("#instruction2-confirm").prop("disabled",!0);let n=null;for(let e=0;e<i;e++){let a=t[e];const o=[a.latitude,a.longitude];if(null!=n){if(Math.hypot(o[0]-n[0],o[1]-n[1])<.001)continue;n=o}else n=o;await sleep(1),$("#instruction2-map-progress").css("width",100*e/i+"%"),addInstruction2Marker(o,moment(a.timestamp).format("MMM D, hh:ss a"))}$("#instruction2-map-progress-div").hide(),$("#instruction2-map-progress").css("width","0%"),rendering=!1}let datePicked=!1,emailValid=!1,fileValid=!1;async function instruction1(){function t(){1==datePicked&&1==emailValid&&1==fileValid?$("#instruction1-confirm").prop("disabled",!1):$("#instruction1-confirm").prop("disabled",!0)}datePicked=!1,emailValid=!1,fileValid=!1,$("#instruction1-confirm").prop("disabled",!0),$("#instruction1-email").val(""),$("#instruction1-daterange").val("");let i=null,n=null,e=null,a=null;$("#instruction1-daterange").daterangepicker({autoUpdateInput:!1,minDate:moment("2020-01-01").toDate(),maxDate:moment().toDate(),opens:"right",locale:{cancelLabel:"Clear"}}),$("#instruction1-daterange").on("apply.daterangepicker",(function(e,a){$(this).val(moment(a.startDate).format("MM/DD/YYYY")+" - "+a.endDate.format("MM/DD/YYYY")),datePicked=!0,i=a.startDate.valueOf(),n=a.endDate.valueOf(),t()})),$("#instruction1-daterange").on("cancel.daterangepicker",(function(i,n){$(this).val(""),datePicked=!1,t()})),$("#instruction1-email").change((function(){const i=$(this);a=i.val(),emailValid=i[0].validity.valid,emailValid?$("#instruction1-email-error").hide():$("#instruction1-email-error").show(),t()})),$("#instruction1-file").change((async function(){const i=$(this).val().split("\\").pop();$(this).siblings(".custom-file-label").addClass("selected").html(i),e=this.files[0];try{fileValid=function(t){if(!Array.isArray(t.locations))return!1;for(const i of t.locations){if("number"!=typeof i.latitudeE7)return!1;if("number"!=typeof i.latitudeE7)return!1;if("number"!=typeof i.latitudeE7)return!1}return!0}(JSON.parse(await e.text()))}catch(t){fileValid=!1}fileValid?$("#instruction1-file-error").hide():$("#instruction1-file-error").show(),t()})),$("#instruction1-confirm").button().click((async function(){$("#instruction1-confirm").prop("disabled",!0);const t=864e5,o=i-14*t,r=Math.max(i+10*t,n+3*t);instruction2Points=JSON.parse(await e.text()).locations.filter((t=>t.timestampMs>=o&&t.timestampMs<r)).map((t=>({latitude:1e-7*t.latitudeE7,longitude:1e-7*t.longitudeE7,timestamp:parseInt(t.timestampMs)}))),await instruction2(a,o)}))}async function instruction2(t,i){loadInstruction2Map(),$("#instruction1-div").hide(),$("#instruction2-div").show(),instruction2Map.invalidateSize(!0),await renderInstruction2Map(),$("#instruction2-confirm").prop("disabled",!1),$("#instruction2-confirm").button().click((async function(){$("#instruction2-wait").show();try{await fetchJson(`${apiUrl()}/uploadlocations/`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({email:t,infect_start:i,locs:getValidPoints()})}),givePermSuccess("Upload Successful")}catch(t){console.log(t);let i="Upload Failed: ";switch(JSON.parse(t.message).code){case 409:i+="This IP has already uploaded data";break;case 422:i+="Malformed Request (Usually due to email)";break;default:i+="Unknown Error (Try again later)"}givePermError(i)}$("#instruction2-wait").hide()}))}$(document).ready((async function(){await instruction1()}));