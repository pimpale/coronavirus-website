const globalMinTimestamp=moment("2017-01-01").valueOf(),globalMaxTimestamp=moment().valueOf();let instruction2Map=null,instruction3Map=null,instruction2Points=null,instruction2Markers=[],exclusionZones=[],minTimestamp=globalMinTimestamp,maxTimestamp=globalMaxTimestamp;function loadInstruction2Map(){instruction2Map=L.map("instruction2-map"),instruction2Map.setView([0,0],2),L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,minZoom:2,id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoicGltcGFsZSIsImEiOiJjazhkbzk4NTIwdHkzM21vMWFiNHIzZ3BiIn0.nLv4P71SFh4TIANuwJ8I9A"}).addTo(instruction2Map);const t=L.featureGroup().addTo(instruction2Map);function n(){exclusionZones=[],t.eachLayer((t=>{exclusionZones.push(t.getBounds())}))}instruction2Map.addControl(new L.Control.Draw({position:"topright",edit:{featureGroup:t,edit:!1,poly:{allowIntersection:!1}},draw:{featureGroup:t,polyline:!1,polygon:!1,circle:!1,marker:!1,rectangle:!0,circlemarker:!1}})),instruction2Map.on(L.Draw.Event.CREATED,(async function(i){rendering||(t.addLayer(i.layer),n(),await renderInstruction2Map())})),instruction2Map.on(L.Draw.Event.DELETED,(async function(i){rendering||(t.removeLayer(i.layer),n(),await renderInstruction2Map())})),$("#instruction2-map-daterange").ionRangeSlider({skin:"round",type:"double",grid:!0,min:minTimestamp,max:maxTimestamp,from:minTimestamp,to:maxTimestamp,prettify:t=>moment(t).format("MMM D, YYYY"),onFinish:async function(){minTimestamp=$("#instruction2-map-daterange").data("from"),maxTimestamp=$("#instruction2-map-daterange").data("to"),await renderInstruction2Map()}})}function addInstruction2Marker(t,n,i){let e=new L.Marker(t);instruction2Map.addLayer(e),null!=i&&e.bindPopup(i),instruction2Markers.push(e)}let rendering=!1;function getValidPoints(){return instruction2Points.filter((t=>t.timestamp>=minTimestamp&&t.timestamp<maxTimestamp)).filter((t=>{for(const n of exclusionZones)if(n.contains([t.latitude,t.longitude]))return!1;return!0}))}async function renderInstruction2Map(){rendering=!0;for(let t=0;t<instruction2Markers.length;t++)instruction2Map.removeLayer(instruction2Markers[t]);instruction2Markers=[],$("#instruction2-map-progress-div").show(),$("#instruction2-map-daterange").data("ionRangeSlider").update({block:!0});const t=getValidPoints(),n=t.length;$("#instruction2-counter").html(`${(n/1e4).toFixed(2)}/10.00 Megabytes Used`),n/1e4<10?$("#instruction2-confirm").prop("disabled",!1):$("#instruction2-confirm").prop("disabled",!0);let i=null;for(let e=0;e<n;e++){let o=t[e];const a=[o.latitude,o.longitude];if(null!=i){if(Math.hypot(a[0]-i[0],a[1]-i[1])<.001)continue;i=a}else i=a;await sleep(1),$("#instruction2-map-progress").css("width",100*e/n+"%"),addInstruction2Marker(a,moment(o.timestamp).format("MMM D, hh:ss a"))}$("#instruction2-map-daterange").data("ionRangeSlider").update({block:!1}),$("#instruction2-map-progress-div").hide(),$("#instruction2-map-progress").css("width","0%"),rendering=!1}async function instruction0(){$("#instruction1-selectfile").prop("disabled",!0),await instruction1()}async function instruction1(){$("#instruction1-file").change((async function(){const t=$(this).val().split("\\").pop();$(this).siblings(".custom-file-label").addClass("selected").html(t);const n=this.files[0];let i=!1;try{i=function(t){if(!Array.isArray(t.locations))return!1;for(const n of t.locations){if("number"!=typeof n.latitudeE7)return!1;if("number"!=typeof n.latitudeE7)return!1;if("number"!=typeof n.latitudeE7)return!1}return!0}(JSON.parse(await n.text()))}catch(t){i=!1}i?($("#instruction1-file-error").hide(),$("#instruction1-confirm").prop("disabled",!1),$("#instruction1-confirm").button().click((async function(){$("#instruction1-confirm").prop("disabled",!0),await instruction2(n)}))):($("#instruction1-file-error").show(),$("#instruction1-confirm").prop("disabled",!0))}))}async function instruction2(t){loadInstruction2Map(),$("#instruction1-div").hide(),$("#instruction2-div").show(),instruction2Map.invalidateSize(!0),instruction2Points=JSON.parse(await t.text()).locations.filter((t=>t.timestampMs>=minTimestamp&&t.timestampMs<maxTimestamp)).map((t=>({latitude:1e-7*t.latitudeE7,longitude:1e-7*t.longitudeE7,timestamp:parseInt(t.timestampMs)}))),await renderInstruction2Map(),$("#instruction2-confirm").prop("disabled",!1),$("#instruction2-confirm").button().click((async function(){$("#instruction2-wait").show();try{const t=await fetchJson(`${apiUrl()}/checklocations/`,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({locs:getValidPoints()})});await instruction3(t.result)}catch(t){givePermError("Failed to check data (Try again later)")}$("#instruction2-wait").hide()}))}let instruction3MarkerDependents=[];function loadInstruction3Map(t){instruction3Map=L.map("instruction3-map"),instruction3Map.setView([0,0],2),L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,minZoom:2,id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoicGltcGFsZSIsImEiOiJjazhkbzk4NTIwdHkzM21vMWFiNHIzZ3BiIn0.nLv4P71SFh4TIANuwJ8I9A"}).addTo(instruction3Map);const n=L.featureGroup().addTo(instruction3Map),i=L.featureGroup().addTo(instruction3Map);for(const i of t){let t=new L.Marker([i.latitude,i.longitude]);t.original_data=i,t.bindPopup(moment(i.timestamp).format("MMM D, hh:ss a")),t.addTo(n)}n.on("click",(function(t){for(let t=0;t<instruction3MarkerDependents.length;t++){let n=instruction3MarkerDependents[t];i.removeLayer(n)}instruction3MarkerDependents=[];const n=t.layer,e=n.original_data;instruction3Map.setView(n.getLatLng(),17);for(const t of e.exposures){let n=new L.Marker([t.latitude,t.longitude],{icon:violetIcon}),o=new L.Polyline([[t.latitude,t.longitude],[e.latitude,e.longitude]]);n.addTo(i),o.addTo(i),instruction3MarkerDependents.push(n),instruction3MarkerDependents.push(o)}}))}async function instruction3(t){loadInstruction3Map(t),0==t.length&&givePermSuccess("No instances of Coronavirus exposure found"),$("#instruction2-div").hide(),$("#instruction3-div").show(),instruction3Map.invalidateSize(!0)}$(document).ready((async function(){await instruction0()}));